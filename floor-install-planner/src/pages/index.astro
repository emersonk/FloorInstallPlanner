---
import Layout from '../layouts/Layout.astro';
import { parseFloorPlanInput, calculateFloorPlanGrid } from '../FloorPlanner.ts';
import type { FloorPlanInput, FloorPlanGrid } from '../FloorPlanner.ts';

// Import the JSON input at build time
import floorplanData from '../../public/floorplan.json';

let input: FloorPlanInput | null = null;
let grid: FloorPlanGrid | null = null;
let error: string | null = null;

try {
  input = parseFloorPlanInput(floorplanData);
  grid = calculateFloorPlanGrid(input);
} catch (e) {
  error = (e as Error).message;
}
---

<Layout>
  <h1>Floor Install Planner</h1>
  {error ? (
    <div style="color: red;">Error: {error}</div>
  ) : input ? (
    <>
      <h2>Input Parameters</h2>
      <ul>
        <li>Room: {input.room_length_mm}mm x {input.room_width_mm}mm</li>
        <li>Plank: {input.plank_length_mm}mm x {input.plank_width_mm}mm</li>
        <li>Expansion gap: {input.expansion_gap_mm}mm</li>
        <li>Max width without gap: {input.max_width_without_gap_mm}mm</li>
        <li>Max length without gap: {input.max_length_without_gap_mm}mm</li>
        <li>Min butt joint offset: {input.min_butt_joint_offset_mm}mm</li>
        <li>Min plank length: {input.min_plank_length_mm}mm</li>
        <li>Min first/last row width: {input.min_first_last_row_width_mm}mm</li>
      </ul>
      <h2>Flooring Layout Visualization</h2>
      {grid ? (
        <>
          <div style="margin-bottom: 1em;">
            <strong>Legend:</strong>
            <span style="display:inline-block;width:1em;height:1em;background:#b3e5fc;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Full Plank
            <span style="display:inline-block;width:1em;height:1em;background:#ffe082;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Cut Plank
            <span style="display:inline-block;width:1em;height:1em;background:#ff8a80;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Cut Too Short
            <span style="display:inline-block;width:1em;height:1em;background:#ce93d8;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Too Narrow (First/Last Row)
            <span style="display:inline-block;width:1em;height:1em;background:#ffe082;border:2px dashed #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Cut for Butt Joint (dashed border)
            <span style="display:inline-block;width:1em;height:1em;background:#eee;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Expansion Gap
          </div>
          {(() => {
            // Calculate the real-world width and length of the room (mm)
            const roomWidth = input.room_width_mm;
            const roomLength = input.room_length_mm;
            // Set max grid width in px
            const maxGridWidthPx = 1000;
            // Calculate aspect ratio (width/length)
            const aspectRatio = roomWidth / roomLength;
            // Set grid width to 100% (up to maxGridWidthPx)
            // Set grid height based on aspect ratio
            const gridWidthPx = maxGridWidthPx;
            const gridHeightPx = Math.round(gridWidthPx / aspectRatio);

            // Build grid-template-columns and grid-template-rows based on cell sizes
            // Each cell's width/height is proportional to its real size
            const colSizes = grid.cells[0].map((cell) => cell.length_mm);
            const rowSizes = grid.cells.map((row) => row[0].width_mm);

            const totalColSize = colSizes.reduce((a, b) => a + b, 0);
            const totalRowSize = rowSizes.reduce((a, b) => a + b, 0);

            const colFracs = colSizes.map((size) => (size / totalColSize).toFixed(4)).join('fr ');
            const rowFracs = rowSizes.map((size) => (size / totalRowSize).toFixed(4)).join('fr ');

            return (
              <div
                style={`
                  display: grid;
                  grid-template-columns: ${colFracs}fr;
                  grid-template-rows: ${rowFracs}fr;
                  gap: 1px;
                  background: #333;
                  width: 100%;
                  max-width: ${maxGridWidthPx}px;
                  height: ${gridHeightPx}px;
                  margin: 0 auto;
                `}
              >
                {grid.cells.map((row, rIdx) =>
                  row.map((cell, cIdx) => {
                    let bg = "#fff";
                    let label = "";
                    let tooltip = "";
                    if (cell.too_narrow) {
                      bg = "#ce93d8"; // purple for too narrow
                      label = "Too Narrow";
                      tooltip = "First/Last row too narrow";
                    } else if (cell.type === "full") {
                      bg = "#b3e5fc";
                      label = "";
                      tooltip = `Full plank (${cell.length_mm}mm x ${cell.width_mm}mm)`;
                    } else if (cell.type === "cut") {
                      if (cell.too_short) {
                        bg = "#ff8a80"; // red for too short
                        label = "Too Short";
                        tooltip = `Cut plank too short (${cell.length_mm}mm x ${cell.width_mm}mm)`;
                      } else {
                        bg = "#ffe082";
                        label = "Cut";
                        tooltip = `Cut plank (${cell.length_mm}mm x ${cell.width_mm}mm)`;
                      }
                    } else if (cell.type === "expansion_gap") {
                      bg = "#eee";
                      label = "";
                      tooltip = "Expansion gap";
                    }

                    // Dashed border for planks cut for butt joint compliance
                    let borderStyle = "1px solid #333";
                    if (cell.cut_for_butt_joint) {
                      borderStyle = "2px dashed #333";
                      tooltip += " (cut for butt joint compliance)";
                    }

                    // Show dimensions inside the cell
                    let dimLabel = "";
                    if (cell.type === "full" || cell.type === "cut") {
                      dimLabel = `${cell.length_mm}Ã—${cell.width_mm}`;
                    }

                    return (
                      <div
                        style={`
                          min-width: 10px;
                          min-height: 10px;
                          background: ${bg};
                          border: ${borderStyle};
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          justify-content: center;
                          font-size: 0.7em;
                          box-sizing: border-box;
                        `}
                        title={tooltip}
                      >
                        <span>{label}</span>
                        <span style="font-size:0.8em;color:#222;">{dimLabel}</span>
                      </div>
                    );
                  })
                )}
              </div>
            );
          })()}
        </>
      ) : (
        <div>No grid data found.</div>
      )}
    </>
  ) : (
    <div>No input data found.</div>
  )}
</Layout>
