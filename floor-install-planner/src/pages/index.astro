---
import Layout from '../layouts/Layout.astro';
import { parseFloorPlanInput, calculateFloorPlanGrid } from '../FloorPlanner.ts';
import type { FloorPlanInput, FloorPlanGrid } from '../FloorPlanner.ts';

// Import the JSON input at build time
import floorplanData from '../../public/floorplan.json';

let input: FloorPlanInput | null = null;
let grid: FloorPlanGrid | null = null;
let error: string | null = null;

try {
  input = parseFloorPlanInput(floorplanData);
  grid = calculateFloorPlanGrid(input);
} catch (e) {
  error = (e as Error).message;
}
---

<Layout>
  <h1>Floor Install Planner</h1>
  {error ? (
    <div style="color: red;">Error: {error}</div>
  ) : input ? (
    <>
      <h2>Input Parameters</h2>
      <ul>
        <li>Room: {input.room_length_mm}mm x {input.room_width_mm}mm</li>
        <li>Plank: {input.plank_length_mm}mm x {input.plank_width_mm}mm</li>
        <li>Expansion gap: {input.expansion_gap_mm}mm</li>
        <li>Max width without gap: {input.max_width_without_gap_mm}mm</li>
        <li>Max length without gap: {input.max_length_without_gap_mm}mm</li>
        <li>Min butt joint offset: {input.min_butt_joint_offset_mm}mm</li>
        <li>Min plank length: {input.min_plank_length_mm}mm</li>
        <li>Min first/last row width: {input.min_first_last_row_width_mm}mm</li>
      </ul>
      <h2>Flooring Layout Visualization</h2>
      {grid ? (
        <>
          <div style="margin-bottom: 1em;">
            <strong>Legend:</strong>
            <span style="display:inline-block;width:1em;height:1em;background:#b3e5fc;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Full Plank
            <span style="display:inline-block;width:1em;height:1em;background:#ffe082;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Cut Plank
            <span style="display:inline-block;width:1em;height:1em;background:#ff8a80;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Cut Too Short
            <span style="display:inline-block;width:1em;height:1em;background:#ce93d8;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Too Narrow (First/Last Row)
            <span style="display:inline-block;width:1em;height:1em;background:#ffb74d;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Joint Too Close
            <span style="display:inline-block;width:1em;height:1em;background:#eee;border:1px solid #333;margin:0 0.5em 0 1em;vertical-align:middle;"></span> Expansion Gap
          </div>
          <div
            style={`
              display: grid;
              grid-template-rows: repeat(${grid.rows}, 24px);
              grid-template-columns: repeat(${grid.cols}, 48px);
              gap: 1px;
              background: #333;
              width: max-content;
            `}
          >
            {grid.cells.map((row, rIdx) =>
              row.map((cell, cIdx) => {
                let bg = "#fff";
                let label = "";
                let tooltip = "";
                if (cell.too_close_butt_joint) {
                  bg = "#ffb74d"; // orange for joint too close
                  label = "Joint Too Close";
                  tooltip = "Butt joint offset violated";
                } else if (cell.too_narrow) {
                  bg = "#ce93d8"; // purple for too narrow
                  label = "Too Narrow";
                  tooltip = "First/Last row too narrow";
                } else if (cell.type === "full") {
                  bg = "#b3e5fc";
                  label = "";
                  tooltip = "Full plank";
                } else if (cell.type === "cut") {
                  if (cell.too_short) {
                    bg = "#ff8a80"; // red for too short
                    label = "Too Short";
                    tooltip = `Cut plank too short (${cell.length_mm}mm x ${cell.width_mm}mm)`;
                  } else {
                    bg = "#ffe082";
                    label = "Cut";
                    tooltip = `Cut plank (${cell.length_mm}mm x ${cell.width_mm}mm)`;
                  }
                } else if (cell.type === "expansion_gap") {
                  bg = "#eee";
                  label = "";
                  tooltip = "Expansion gap";
                }
                return (
                  <div
                    style={`
                      width: 48px;
                      height: 24px;
                      background: ${bg};
                      border: 1px solid #333;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 0.7em;
                      box-sizing: border-box;
                    `}
                    title={tooltip}
                  >
                    {label}
                  </div>
                );
              })
            )}
          </div>
        </>
      ) : (
        <div>No grid data found.</div>
      )}
    </>
  ) : (
    <div>No input data found.</div>
  )}
</Layout>
